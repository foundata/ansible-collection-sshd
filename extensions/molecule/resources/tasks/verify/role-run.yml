# Tasks for the Molecule verify stage: Check collection role "run" outcomes.

- name: "Molecule | Verify | Initialize the foundata.sshd.run role (without actually running it; get and expose variables)"
  ansible.builtin.include_role:
    name: "foundata.sshd.run"
    tasks_from: "init"
    public: true


- name: "Molecule | Verify | Gather service facts"
  ansible.builtin.service_facts:


- name: "Molecule | Verify | Show service facts"
  ansible.builtin.debug:
    var: ansible_facts['services']
    verbosity: 3


- name: "Molecule | Verify | Assert SSH service is running"
  ansible.builtin.assert:
    that:
      - ansible_facts['services'][__run_sshd_sshd_servicename] is defined
      - ansible_facts['services'][__run_sshd_sshd_servicename].state == 'running'
    fail_msg: "SSH service '{{ __run_sshd_sshd_servicename }}' is not running"
    success_msg: "SSH service '{{ __run_sshd_sshd_servicename }}' is running"


# Regression tests for sshd_config commenting logic.
# Background: On Fedora 43, the 50-redhat.conf contains a TAB-indented line
# which caused empty strings to enter the options list. When joined with '|',
# this created patterns like 'Port||HostKey' where '||' matches empty strings,
# causing every line to be re-commented on each run (adding '#' repeatedly).
- name: "Molecule | Verify | Read main sshd_config content"
  ansible.builtin.slurp:
    src: "{{ __run_sshd_config_file }}"
  register: __testing_sshd_config_content


- name: "Molecule | Verify | Check for double-commented lines in sshd_config"
  ansible.builtin.set_fact:
    __testing_double_commented_lines: >-
      {{ (__testing_sshd_config_content['content'] | b64decode).split('\n')
         | select('match', '^##')
         | list }}


- name: "Molecule | Verify | Assert no double-commented lines exist (regex idempotency)"
  ansible.builtin.assert:
    that:
      - __testing_double_commented_lines | length == 0
    fail_msg: >-
      Found {{ __testing_double_commented_lines | length }} double-commented lines in
      {{ __run_sshd_config_file }}. This indicates the commenting regex matched
      already-commented lines. Lines: {{ __testing_double_commented_lines[:5] }}
    success_msg: "No double-commented lines found - commenting regex is idempotent"


- name: "Molecule | Verify | Check that Include directive is not commented out"
  ansible.builtin.shell: |
    grep -c '^Include ' {{ __run_sshd_config_file }} || echo "0"
  args:
    executable: "/bin/bash"
  register: __testing_include_count
  changed_when: false


- name: "Molecule | Verify | Assert Include directive exists and is active"
  ansible.builtin.assert:
    that:
      - __testing_include_count.stdout | int > 0
    fail_msg: >-
      No active 'Include' directive found in {{ __run_sshd_config_file }}.
      The Include directive should not be commented out.
    success_msg: "Include directive is present and active"


- name: "Molecule | Verify | Extract configured SSH port"
  ansible.builtin.set_fact:
    __testing_configured_ssh_port: >-
      {{
        __run_sshd_effective_sshd_settings.Port | default(22) | int
        if (__run_sshd_effective_sshd_settings is defined and
            __run_sshd_effective_sshd_settings['Port'] is defined)
        else 22
      }}


- name: "Molecule | Verify | Display configured SSH port"
  ansible.builtin.debug:
    var: __testing_configured_ssh_port
    verbosity: 1


- name: "Molecule | Verify | Run ssh-audit against localhost on configured port"
  ansible.builtin.shell: |-
    ssh-audit localhost:{{ __testing_configured_ssh_port }} -jj > /tmp/ssh-audit-result.json
  args:
    executable: "/bin/bash"
  register: __testing_ssh_audit_run
  changed_when:
    - __testing_ssh_audit_run['rc'] != 1
  failed_when:
    - __testing_ssh_audit_run['rc'] == 1 # other exit codes >0 are reporting SSH config errors


- name: "Molecule | Verify | Read ssh-audit JSON results"
  ansible.builtin.slurp:
    src: "/tmp/ssh-audit-result.json"
  when:
    - __testing_ssh_audit_run is defined
    - __testing_ssh_audit_run['rc'] is defined
  register: __testing_ssh_audit_json_encoded


- name: "Molecule | Verify | Parse ssh-audit results"
  ansible.builtin.set_fact:
    __testing_ssh_audit_results: "{{ __testing_ssh_audit_json_encoded['content'] | b64decode | from_json }}"
  when:
    - __testing_ssh_audit_json_encoded is defined
    - __testing_ssh_audit_json_encoded['content'] is defined


- name: "Molecule | Verify | Check for CVEs or warnings and failures in recommendations"
  ansible.builtin.set_fact:
    __testing_ssh_audit_cves: "{{ __testing_ssh_audit_results['cves'] | default({}) | length > 0 }}"
    __testing_ssh_audit_warnings: "{{ __testing_ssh_audit_results['recommendations']['warning'] | default({}) | length > 0 }}"
    __testing_ssh_audit_failures: "{{ __testing_ssh_audit_results['recommendations']['critical'] | default({}) | length > 0 }}"
  when:
    - __testing_ssh_audit_results is defined
    - __testing_ssh_audit_results['recommendations'] is defined


- name: "Molecule | Verify | Assert SSH configuration is secure"
  ansible.builtin.assert:
    that:
      - __testing_ssh_audit_run is defined
      - __testing_ssh_audit_run['rc'] is defined
      - not __testing_ssh_audit_cves
      - not __testing_ssh_audit_warnings
      - not __testing_ssh_audit_failures
    fail_msg: "ssh-audit detected issues (CVE, warning or failure) or failed to run. Please check /tmp/ssh-audit-result.json for details."
    success_msg: "ssh-audit verified SSH configuration with no issues."
