# Tasks for the Molecule verify stage: Check collection role "run" outcomes.

- name: "Molecule | Verify | Initialize the foundata.sshd.run role (without actually running it; get and expose variables)"
  ansible.builtin.include_role:
    name: "foundata.sshd.run"
    tasks_from: "init"
    public: true


- name: "Molecule | Verify | Set / overwrite some expected configuration data "
  ansible.builtin.set_fact:
    # values have to be in sync with the config set in ../converge/run-role.yml
    run_sshd_config_dropin_file_name: "00-custom-dropin.conf"
    __run_sshd_config_dropin_file_path: "{{ __run_sshd_config_dropin_dir_path }}/00-custom-dropin.conf"
    # other testing specific values
    __testing_journalctl_executable: >-
      {{
        '/bin/journalctl'
        if (ansible_facts['distribution'] == 'Debian' and ansible_facts['distribution_major_version'] | int == 11)
        else '/usr/bin/journalctl'
      }}


- name: "Molecule | Verify | Check if sshd drop-in configuration file exists"
  ansible.builtin.stat:
    path: "{{ __run_sshd_config_dropin_file_path }}"
  register: __testing_dropin_file


- name: "Molecule | Verify | Assert sshd drop-in configuration file exists"
  ansible.builtin.assert:
    that:
      - __testing_dropin_file['stat']['exists']
    fail_msg: "The sshd drop-in configuration file '{{ __run_sshd_config_dropin_file_path }}' does not exist."
    success_msg: "The sshd drop-in configuration file '{{ __run_sshd_config_dropin_file_path }}' exists."


- name: "Molecule | Verify | Check if default sshd drop-in configuration file does exists (if custom filename is used)"
  ansible.builtin.stat:
    path: "{{ __run_sshd_config_dropin_file_path_default }}"
  when:
    - __run_sshd_config_dropin_file_path != __run_sshd_config_dropin_file_path_default
  register: __testing_dropin_file_default


- name: "Molecule | Verify | Assert default sshd drop-in configuration file does not exists (if custom filename is used)"
  ansible.builtin.assert:
    that:
      - __testing_dropin_file_default['stat']['exists'] is false
    fail_msg: >-
      The default sshd drop-in configuration file '{{ __run_sshd_config_dropin_file_path }}' exists (even though a custom filename is used).
    success_msg: >-
      The default sshd drop-in configuration file '{{ __run_sshd_config_dropin_file_path }}' does not exist (valid as custom filename is used).
  when:
    - __run_sshd_config_dropin_file_path != __run_sshd_config_dropin_file_path_default


- name: "Molecule | Verify | Gather service facts"
  ansible.builtin.service_facts:


- name: "Molecule | Verify | Show service facts"
  ansible.builtin.debug:
    var: ansible_facts['services']
    verbosity: 3


- name: "Molecule | Verify | Assert SSH service is running"
  ansible.builtin.assert:
    that:
      - ansible_facts['services'][__run_sshd_sshd_servicename] is defined
      - ansible_facts['services'][__run_sshd_sshd_servicename].state == 'running'
    fail_msg: "SSH service '{{ __run_sshd_sshd_servicename }}' is not running"
    success_msg: "SSH service '{{ __run_sshd_sshd_servicename }}' is running"


- name: "Molecule | Verify | Read main sshd config file content"
  ansible.builtin.slurp:
    src: "{{ __run_sshd_config_file_path }}"
  register: __testing_sshd_config


- name: "Molecule | Verify | Decode main sshd config file content"
  ansible.builtin.set_fact:
    __testing_sshd_config_content: "{{ __testing_sshd_config['content'] | ansible.builtin.b64decode }}"


- name: "Molecule | Verify | Assert some Options are commented out in the default daemon config file"
  ansible.builtin.assert:
    that:
      # Line is commented (allow indentation), then optional spaces after '#',
      # then the directive name as a whole token, then whitespace or EOL.
      - __testing_sshd_config_content is search('(?m)^[\t ]*#[\t ]*AuthorizedKeysFile(?=[\t ]|$)')
      - __testing_sshd_config_content is search('(?m)^[\t ]*#[\t ]*Subsystem(?=[\t ]|$)')
      # Optional: also ensure they are not still active anywhere
      - not (__testing_sshd_config_content is search('(?m)^(?![\t ]*#)[\t ]*AuthorizedKeysFile(?=[\t ]|$)'))
      - not (__testing_sshd_config_content is search('(?m)^(?![\t ]*#)[\t ]*Subsystem(?=[\t ]|$)'))
    fail_msg: >-
      Expected some options to be commented out in {{ __run_sshd_config_file_path }}, but one or more
      were not. Ensure the role's commenting logic ran and these directives exist in the file.
    success_msg: >-
      Expected Options are commented out and not present as active directives in
      {{ __run_sshd_config_file_path }}.


# Regression tests for sshd_config commenting logic.
# Background: On Fedora 43, the 50-redhat.conf contains a TAB-indented line
# which caused empty strings to enter the options list. When joined with '|',
# this created patterns like 'Port||HostKey' where '||' matches empty strings,
# causing every line to be re-commented on each run (adding '#' repeatedly).
- name: "Molecule | Verify | Check for double-commented lines in sshd_config"
  ansible.builtin.set_fact:
    __testing_double_commented_lines: >-
      {{ (__testing_sshd_config_content).split('\n')
         | select('match', '^##')
         | ansible.builtin.list }}


- name: "Molecule | Verify | Assert no double-commented lines exist (regex idempotency)"
  ansible.builtin.assert:
    that:
      - __testing_double_commented_lines | ansible.builtin.length == 0
    fail_msg: >-
      Found {{ __testing_double_commented_lines | ansible.builtin.length }} double-commented lines in
      {{ __run_sshd_config_file_path }}. This indicates the commenting regex matched
      already-commented lines. Lines: {{ __testing_double_commented_lines[:5] }}
    success_msg: "No double-commented lines found - commenting regex is idempotent"


- name: "Molecule | Verify | Assert Include directive exists and is active"
  ansible.builtin.assert:
    that:
      - __testing_sshd_config_content is search('(?m)^(?![ \t]*#)[ \t]*Include(?=[ \t]|$)')
    fail_msg: >-
      No active 'Include' directive found in {{ __run_sshd_config_file_path }}.
    success_msg: >-
      Include directive is present and active in {{ __run_sshd_config_file_path }}.


- name: "Molecule | Verify | Extract configured SSH port"
  ansible.builtin.set_fact:
    __testing_configured_ssh_port: >-
      {{
        __run_sshd_effective_sshd_settings['Port'] | ansible.builtin.default(22) | int
        if (__run_sshd_effective_sshd_settings is defined and
            __run_sshd_effective_sshd_settings['Port'] is defined)
        else 22
      }}


- name: "Molecule | Verify | Display configured SSH port"
  ansible.builtin.debug:
    var: __testing_configured_ssh_port
    verbosity: 1


- name: "Molecule | Verify | Set regular expression to search for warnings and errors in the journal"
  ansible.builtin.set_fact:
    __testing_regex_searchwarningerror: '(?i)\b(warning|error|unsupported)'


- name: "Molecule | Verify | Check journal for warnings or errors: sshd"
  ansible.builtin.command:
    argv:
      - "{{ __testing_journalctl_executable }}"
      - '--unit={{ __run_sshd_sshd_servicename | regex_replace("\.service$", "*") }}'
  changed_when: false
  failed_when:
    - (__testing_run_journalctlcheck_result['stdout'] is search(__testing_regex_searchwarningerror))
  register: __testing_run_journalctlcheck_result


# ssh-audit (must run after checking the journal for errors, as the audit can
# trigger log entries such as: error: kex_exchange_identification)

- name: "Molecule | Verify | Run ssh-audit against localhost on configured port"
  ansible.builtin.shell: |-
    ssh-audit localhost:{{ __testing_configured_ssh_port | int }} -jj > /tmp/ssh-audit-result.json
  args:
    executable: "/bin/bash"
  register: __testing_ssh_audit_run
  changed_when:
    - __testing_ssh_audit_run['rc'] != 1
  failed_when:
    - __testing_ssh_audit_run['rc'] == 1 # other exit codes >0 are reporting SSH config errors


- name: "Molecule | Verify | Read ssh-audit JSON results"
  ansible.builtin.slurp:
    src: "/tmp/ssh-audit-result.json"
  when:
    - __testing_ssh_audit_run is defined
    - __testing_ssh_audit_run['rc'] is defined
  register: __testing_ssh_audit_json_encoded


- name: "Molecule | Verify | Parse ssh-audit results"
  ansible.builtin.set_fact:
    __testing_ssh_audit_results: "{{ __testing_ssh_audit_json_encoded['content'] | ansible.builtin.b64decode | from_json }}"
  when:
    - __testing_ssh_audit_json_encoded is defined
    - __testing_ssh_audit_json_encoded['content'] is defined


- name: "Molecule | Verify | Check for CVEs or warnings and failures in recommendations"
  ansible.builtin.set_fact:
    __testing_ssh_audit_cves: "{{ __testing_ssh_audit_results['cves'] | ansible.builtin.default({}) | ansible.builtin.length > 0 }}"
    __testing_ssh_audit_warnings: "{{ __testing_ssh_audit_results['recommendations']['warning'] | ansible.builtin.default({}) | ansible.builtin.length > 0 }}"
    __testing_ssh_audit_failures: "{{ __testing_ssh_audit_results['recommendations']['critical'] | ansible.builtin.default({}) | ansible.builtin.length > 0 }}"
  when:
    - __testing_ssh_audit_results is defined
    - __testing_ssh_audit_results['recommendations'] is defined


- name: "Molecule | Verify | Assert SSH config is secure"
  ansible.builtin.assert:
    that:
      - __testing_ssh_audit_run is defined
      - __testing_ssh_audit_run['rc'] is defined
      - not __testing_ssh_audit_cves
      - not __testing_ssh_audit_warnings
      - not __testing_ssh_audit_failures
    fail_msg: "ssh-audit detected issues (CVE, warning or failure) or failed to run. Please check /tmp/ssh-audit-result.json for details."
    success_msg: "ssh-audit verified SSH config with no issues."


# OS-specific overwrite verification (text-based)
# Ensures that any key defined in __run_sshd_sshd_settings_overwrite does not
# appear as an active directive in the sshd_config file content.

- name: "Molecule | Verify | Read drop-in sshd config file content"
  ansible.builtin.slurp:
    src: "{{ __run_sshd_config_dropin_file_path }}"
  register: __testing_sshd_dropin_config


- name: "Molecule | Verify | Decode drop-in sshd_config file content"
  ansible.builtin.set_fact:
    __testing_sshd_dropin_config_content: "{{ __testing_sshd_dropin_config['content'] | ansible.builtin.b64decode }}"


- name: "Molecule | Verify | Assert overwritten settings to drop (value: null) (if any) are not in sshd_config"
  ansible.builtin.assert:
    that:
      # Match active (not commented) directive: start of line, optional whitespace,
      # NOT a comment, then the directive name followed by whitespace or EOL
      - not (__testing_sshd_dropin_config_content is search('(?mi)^(?![\t ]*#)[\t ]*' ~ item ~ '(?=[\t ]|$)'))
    fail_msg: >-
      Directive '{{ item }}' was found as active in sshd drop-in config but should have
      been removed by __run_sshd_sshd_settings_overwrite. This OS does not support this
      option or it conflicts with OS-specific requirements.
    success_msg: "Directive '{{ item }}' correctly absent from sshd_config."
  loop: >-
    {{
      __run_sshd_sshd_settings_overwrite | dict2items
      | selectattr('value', 'in', [none, ''])
      | ansible.builtin.map(attribute='key') | ansible.builtin.list
    }}
  when:
    - __run_sshd_sshd_settings_overwrite | ansible.builtin.length > 0


- name: "Molecule | Verify | Assert overwritten settings with specific values are present in sshd_config"
  ansible.builtin.assert:
    that:
      # Match active directive with expected value: key followed by whitespace and value
      - >-
        __testing_sshd_dropin_config_content is search(
          '(?mi)^[\t ]*' ~ item['key'] ~ '[\t ]+' ~ (item['value'] | string | regex_escape) ~ '[\t ]*$'
        )
    fail_msg: >-
      Directive '{{ item['key'] }}' with value '{{ item['value'] }}' was not found in sshd drop-in config
      but should have been set by __run_sshd_sshd_settings_overwrite.
    success_msg: "Directive '{{ item['key'] }}' correctly set to '{{ item['value'] }}' in sshd_config."
  loop: >-
    {{
      __run_sshd_sshd_settings_overwrite | dict2items
      | rejectattr('value', 'in', [none, ''])
      | ansible.builtin.list
    }}
  when:
    - __run_sshd_sshd_settings_overwrite | ansible.builtin.length > 0


# Permission Verification Tests
#
# This section verifies that the role applies filesystem permissions that match
# both the role's configured variables AND the expected OS package defaults
# as they should be aligned.

- name: "Molecule | Verify | Define symbolic-to-octal mode conversion map"
  ansible.builtin.set_fact:
    __testing_mode_map:
      "u=rw,g=,o=": "0600"
      "u=rw,g=r,o=": "0640"
      "u=rw,g=r,o=r": "0644"
      "u=rwx,g=,o=": "0700"
      "u=rwx,g=x,o=x": "0711"
      "u=rwx,g=rx,o=rx": "0755"
      "u=rx,g=rx,o=rx": "0555"


- name: "Molecule | Verify | Define paths to verify"
  ansible.builtin.set_fact:
    __testing_paths_to_verify:

      - path: "{{ __run_sshd_config_file_path }}"
        os_matrix_key: "config_file_mode"
        expected_mode_role: "{{ __run_sshd_config_file_mode }}"
        expected_owner: "{{ __run_sshd_config_file_owner }}"
        expected_group: "{{ __run_sshd_config_file_group }}"

      - path: "{{ __run_sshd_config_dropin_dir_path }}"
        os_matrix_key: "config_dropin_dir_mode"
        expected_mode_role: "{{ __run_sshd_config_dropin_dir_mode }}"
        expected_owner: "{{ __run_sshd_config_dropin_dir_owner }}"
        expected_group: "{{ __run_sshd_config_dropin_dir_group }}"

      - path: "{{ __run_sshd_config_dropin_file_path }}"
        os_matrix_key: "config_dropin_file_mode"
        expected_mode_role: "{{ __run_sshd_config_dropin_file_mode }}"
        expected_owner: "{{ __run_sshd_config_dropin_file_owner }}"
        expected_group: "{{ __run_sshd_config_dropin_file_group }}"

      - path: "{{ __run_sshd_privseparation_dir_path }}"
        os_matrix_key: "privseparation_mode"
        expected_mode_role: "{{ __run_sshd_privseparation_dir_mode }}"
        expected_owner: "{{ __run_sshd_privseparation_dir_owner }}"
        expected_group: "{{ __run_sshd_privseparation_dir_group }}"

      - path: "{{ __run_sshd_hostkey_rsa_file_path }}"
        os_matrix_key: "hostkey_mode"
        expected_mode_role: "{{ __run_sshd_hostkey_files_mode }}"

      - path: "{{ __run_sshd_hostkey_ecdsa_file_path }}"
        os_matrix_key: "hostkey_mode"
        expected_mode_role: "{{ __run_sshd_hostkey_files_mode }}"

      - path: "{{ __run_sshd_hostkey_ed25519_file_path }}"
        os_matrix_key: "hostkey_mode"
        expected_mode_role: "{{ __run_sshd_hostkey_files_mode }}"


- name: "Molecule | Verify | Stat all paths to verify"
  ansible.builtin.stat:
    path: "{{ item['path'] }}"
  loop: "{{ __testing_paths_to_verify }}"
  loop_control:
    label: "{{ item['path'] }}"
  register: __testing_stat_results
  failed_when: false


- name: "Molecule | Verify | Build platform key for matrix lookup"
  ansible.builtin.set_fact:
    __testing_platform_key: "{{ ansible_facts['distribution'] }}-{{ ansible_facts['distribution_major_version'] }}"


# Verify: Role permissions match OS package defaults (static matrix)
#
# The static permission matrix below contains known-good values determined by
# installing openssh-server fresh on each OS and recording the default
# permissions.
# Values determined by fresh openssh installation on each distribution+version.
# Keys use distribution name + major version (ansible_facts['distribution_major_version']).
# See prepare/all.yml for instructions on how to update / determine values for
# new OSes.
- name: "Molecule | Verify | Define OS permission matrix"
  ansible.builtin.set_fact:
    __testing_os_permission_matrix:
      # Debian family
      "Debian-12":
        config_file_mode: "0644"
        config_dropin_dir_mode: "0755"
        config_dropin_file_mode: "0644"
        hostkey_mode: "0600"
        privseparation_mode: "0755"
      "Debian-13":
        config_file_mode: "0644"
        config_dropin_dir_mode: "0755"
        config_dropin_file_mode: "0644"
        hostkey_mode: "0600"
        privseparation_mode: "0755"
      "Ubuntu-22":
        config_file_mode: "0644"
        config_dropin_dir_mode: "0755"
        config_dropin_file_mode: "0644"
        hostkey_mode: "0600"
        privseparation_mode: "0755"
      "Ubuntu-24":
        config_file_mode: "0644"
        config_dropin_dir_mode: "0755"
        config_dropin_file_mode: "0644"
        hostkey_mode: "0600"
        privseparation_mode: "0755"
      # RedHat family
      "Fedora-42":
        config_file_mode: "0600"
        config_dropin_dir_mode: "0700"
        config_dropin_file_mode: "0600"
        hostkey_mode: "0600"
        privseparation_mode: "0711"
      "Fedora-43":
        config_file_mode: "0600"
        config_dropin_dir_mode: "0700"
        config_dropin_file_mode: "0600"
        hostkey_mode: "0600"
        privseparation_mode: "0711"
      "AlmaLinux-9":
        config_file_mode: "0600"
        config_dropin_dir_mode: "0700"
        config_dropin_file_mode: "0600"
        hostkey_mode: "0600"
        privseparation_mode: "0711"
      "AlmaLinux-10":
        config_file_mode: "0600"
        config_dropin_dir_mode: "0700"
        config_dropin_file_mode: "0600"
        hostkey_mode: "0600"
        privseparation_mode: "0711"
      "CentOS-9":
        config_file_mode: "0600"
        config_dropin_dir_mode: "0700"
        config_dropin_file_mode: "0600"
        hostkey_mode: "0600"
        privseparation_mode: "0711"
      "CentOS-10":
        config_file_mode: "0600"
        config_dropin_dir_mode: "0700"
        config_dropin_file_mode: "0600"
        hostkey_mode: "0600"
        privseparation_mode: "0711"
      # SUSE family
      "openSUSE Leap-16":
        config_file_mode: "0640"
        config_dropin_dir_mode: "0755"
        config_dropin_file_mode: "0640"
        hostkey_mode: "0600"
        privseparation_mode: "0555"


# Fail if platform is not in the known permission matrix to ensure developers
# add expected values for new OSes/versions.
- name: "Molecule | Verify | Fail if platform not in permission verification matrix"
  ansible.builtin.fail:
    msg: |
      Platform '{{ __testing_platform_key }}' is not defined in the permission verification matrix.

      To add support for this platform:
      1. Start a molecule container: molecule login --host={{ inventory_hostname }}
      2. Purge openssh and remove config directories:
         - Debian/Ubuntu specific:
           apt purge -y openssh-server
         - Red Hat/Fedora specific:
           dnf remove -y openssh-server
         - SUSE specific:
           zypper remove -y openssh-server
         - All:
           rm -rf /etc/ssh /usr/etc/ssh
      3. Reinstall openssh-server fresh:
         - Debian/Ubuntu:
           apt update && apt install -y openssh-server
         - Red Hat/Fedora:
           dnf install -y openssh-server
         - SUSE:
           zypper install -y openssh-server
      4. Restart sshd (may (re)create privilege separation dir):
         systemctl restart sshd.service
      5. Check the default permissions:
         - All:
           stat -c '%a %n' /etc/ssh/sshd_config /etc/ssh/sshd_config.d /etc/ssh/ssh_host_*_key 2>/dev/null
         - Red Hat/Fedora specific:
           stat -c '%a %n' /usr/share/empty.sshd 2>/dev/null
         - Debian/Ubuntu specific:
           stat -c '%a %n' /run/sshd 2>/dev/null
         - openSUSE specific:
           stat -c '%a %n' /usr/etc/ssh/sshd_config 2>/dev/null
           stat -c '%a %n' /var/lib/empty 2>/dev/null
      6. Add the values to __testing_os_permission_matrix above.
  when:
    - __testing_platform_key not in __testing_os_permission_matrix.keys()


- name: "Molecule | Verify | Build permission verification list"
  ansible.builtin.set_fact:
    __testing_permissions: |
      {% set items = [] %}
      {% for i in range(__testing_paths_to_verify | ansible.builtin.length) %}
      {%   set spec = __testing_paths_to_verify[i] %}
      {%   set result = __testing_stat_results['results'][i] %}
      {%   if result['stat']['exists'] | ansible.builtin.default(false) %}
      {%     set expected_mode_os = __testing_os_permission_matrix[__testing_platform_key][spec['os_matrix_key']]
               if spec['os_matrix_key'] else none %}
      {%     set _ = items.append({
               'path': spec['path'],
               'mode': result['stat']['mode'],
               'expected_mode_role': __testing_mode_map[spec['expected_mode_role']],
               'expected_mode_os': expected_mode_os,
               'owner': result['stat']['pw_name'] | ansible.builtin.default(''),
               'expected_owner': spec['expected_owner'] | ansible.builtin.default(''),
               'group': result['stat']['gr_name'] | ansible.builtin.default(''),
               'expected_group': spec['expected_group'] | ansible.builtin.default('')
             }) %}
      {%   endif %}
      {% endfor %}
      {{ items }}


- name: "Molecule | Verify | Assert permissions match role variables"
  ansible.builtin.assert:
    that:
      - item['mode'] == item['expected_mode_role']
      - item['owner'] == item['expected_owner'] or item['expected_owner'] == ''
      - item['group'] == item['expected_group'] or item['expected_group'] == ''
    fail_msg: >-
      {{ item['path'] }} permissions mismatch with role variables.
      Expected: mode={{ item['expected_mode_role'] }}, owner={{ item['expected_owner'] }}, group={{ item['expected_group'] }}.
      Got: mode={{ item['mode'] }}, owner={{ item['owner'] }}, group={{ item['group'] }}.
    success_msg: "{{ item['path'] }} OK ({{ item['mode'] }})"
  loop: "{{ __testing_permissions }}"
  loop_control:
    label: "{{ item['path'] }}"


- name: "Molecule | Verify | Assert permissions match OS defaults"
  ansible.builtin.assert:
    that:
      - item['mode'] == item['expected_mode_os']
    fail_msg: >-
      {{ item['path'] }} mode differs from OS default!
      Current: {{ item['mode'] }}. OS default ({{ __testing_platform_key }}): {{ item['expected_mode_os'] }}.
      Update role vars or __testing_os_permission_matrix if OS defaults changed.
    success_msg: "{{ item['path'] }} matches OS default ({{ item['mode'] }})"
  loop: "{{ __testing_permissions | selectattr('expected_mode_os', 'defined') | rejectattr('expected_mode_os', 'none') | ansible.builtin.list }}"
  loop_control:
    label: "{{ item['path'] }}"
